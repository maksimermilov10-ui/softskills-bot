import os
import logging
from typing import List, Union, Optional
from contextlib import asynccontextmanager
from http import HTTPStatus
from pathlib import Path

from fastapi import FastAPI, Request, Response, status
from fastapi.staticfiles import StaticFiles

from telegram import (
    Update,
    InlineKeyboardButton,
    InlineKeyboardMarkup,
    InputMediaPhoto,
    BotCommand,
)
from telegram.ext import (
    Application,
    CommandHandler,
    CallbackQueryHandler,
    ContextTypes,
)
from telegram.constants import ChatAction

# ---------- –õ–æ–≥–∏ ----------
logging.basicConfig(
    format="%(asctime)s | %(levelname)s | %(name)s | %(message)s",
    level=logging.INFO,
)
log = logging.getLogger("softskills-bot")

# ---------- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ----------
BOT_TOKEN = os.getenv("BOT_TOKEN")
if not BOT_TOKEN:
    raise SystemExit('–ù–µ –∑–∞–¥–∞–Ω BOT_TOKEN. export BOT_TOKEN="<—Ç–æ–∫–µ–Ω>"')  # –∫—Ä–∏—Ç–∏—á–Ω–æ [11]

PUBLIC_BASE_URL = os.getenv("PUBLIC_BASE_URL", "").rstrip("/")

TEST_LINK = "https://softskills.rsv.ru/"

# ---------- –°—Ç–∞—Ç–∏–∫–∞ ----------
BASE_DIR = Path(__file__).parent
STATIC_DIR = BASE_DIR / "static"
IMAGES_DIR = STATIC_DIR / "images"
IMAGES_DIR.mkdir(parents=True, exist_ok=True)

def media_path(name: str) -> Path:
    return IMAGES_DIR / name  # /static —Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω –Ω–∏–∂–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ –±—Ä–∞—É–∑–µ—Ä–µ [7]

# ---------- –ö–æ–ª–±—ç–∫–∏ ----------
CB_MAIN = "main_menu"
CB_MENU_TEST = "menu_test"
CB_MENU_ANN = "menu_ann"

CB_TEST = "test"
CB_GUIDE_OPEN = "guide_open"
CB_GUIDE_FAST = "guide_fast"
CB_GUIDE_NEXT = "guide_next"
CB_GUIDE_PREV = "guide_prev"
CB_GUIDE_MENU = "guide_menu"  # –≤–Ω—É—Ç—Ä–∏ –≥–∞–π–¥–∞
CB_EVENTS = "events"

CB_REMINDER = "reminder_toggle"  # –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è

# ---------- –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã ----------
def kb_root() -> InlineKeyboardMarkup:
    return InlineKeyboardMarkup(
        [
            [InlineKeyboardButton("–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ", callback_data=CB_MENU_TEST)],
            [InlineKeyboardButton("–ê–Ω–æ–Ω—Å—ã –∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ", callback_data=CB_MENU_ANN)],
        ]
    )  # –¥–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–æ–µ –º–µ–Ω—é [4][2]

def kb_test_menu() -> InlineKeyboardMarkup:
    return InlineKeyboardMarkup(
        [
            [InlineKeyboardButton("–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è (–ø–æ —à–∞–≥–∞–º)", callback_data=CB_GUIDE_OPEN)],
            [InlineKeyboardButton("–£–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω(–∞)", callback_data=CB_GUIDE_FAST)],
            [InlineKeyboardButton("–ü—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ", callback_data=CB_TEST)],
            [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data=CB_MAIN)],
        ]
    )  # –ø–æ–¥–º–µ–Ω—é —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è [4]

def kb_ann_menu() -> InlineKeyboardMarkup:
    return InlineKeyboardMarkup(
        [
            [InlineKeyboardButton("–ë–ª–∏–∂–∞–π—à–∏–µ –∞–Ω–æ–Ω—Å—ã", callback_data=CB_EVENTS)],
            [InlineKeyboardButton("–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ (–≤–∫–ª/–≤—ã–∫–ª)", callback_data=CB_REMINDER)],
            [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data=CB_MAIN)],
        ]
    )  # –ø–æ–¥–º–µ–Ω—é –∞–Ω–æ–Ω—Å–æ–≤/–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π [4]

def kb_guide(idx: int, last: int) -> InlineKeyboardMarkup:
    row = []
    if idx > 0:
        row.append(InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data=f"{CB_GUIDE_PREV}:{idx-1}"))
    if idx < last:
        row.append(InlineKeyboardButton("–î–∞–ª–µ–µ ‚û°Ô∏è", callback_data=f"{CB_GUIDE_NEXT}:{idx+1}"))
    # –ö–Ω–æ–ø–∫–∞ "–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é" –≤–µ–¥—ë—Ç –∫ –∫–æ—Ä–Ω—é –∏–∑ 2 –∫–Ω–æ–ø–æ–∫
    return InlineKeyboardMarkup([row] if row else [] + [[InlineKeyboardButton("–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data=CB_MAIN)]])

# ---------- –¢–µ–∫—Å—Ç —à–∞–≥–æ–≤ ----------
GUIDE_TEXTS: List[str] = [
    "1) –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ\n\n–°–æ–∑–¥–∞–π –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç, –Ω–∞–∂–º–∏ ¬´–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è¬ª, –≤–≤–µ–¥–∏ –∫–æ–¥ –∏–∑ –ø–∏—Å—å–º–∞.",
    "2) –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∞–Ω–∫–µ—Ç—ã\n\n–ó–∞–ø–æ–ª–Ω–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –∏ —É–∫–∞–∂–∏ –¶–µ–Ω—Ç—Ä –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–π.",
    "3) –ü—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è\n\n–ë–∞–∑–æ–≤—ã–µ –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã; –æ—Ç—á—ë—Ç—ã –ø–æ—è–≤—è—Ç—Å—è –≤ —Ç–µ—á–µ–Ω–∏–µ 48 —á–∞—Å–æ–≤.",
    f"4) –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ —Å–∞–π—Ç\n\n–ó–∞–π–¥–∏ —Å –∫–æ–º–ø—å—é—Ç–µ—Ä–∞: {TEST_LINK}\n–£–∫–∞–∑—ã–≤–∞–π e‚Äëmail, –Ω–µ —Ç–µ–ª–µ—Ñ–æ–Ω.",
    "5) –ù–∞–∂–∞—Ç—å ¬´–ù–∞—á–∞—Ç—å¬ª –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∫–µ—Ç—É\n\n–ó–∞–ø–æ–ª–Ω–∏ –§–ò–û –∏ –¥–∞–Ω–Ω—ã–µ –æ–± –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–∏.",
    "6) –§–∏–Ω–∏—à–Ω–∞—è –ø—Ä—è–º–∞—è! üèÅ\n\n–ü—Ä–æ–π–¥–∏ 4 –±–∞–∑–æ–≤—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ (—Å–∏–Ω–∏–µ –º–∞—Ä–∫–µ—Ä—ã).",
]
LAST_STEP = len(GUIDE_TEXTS) - 1

# ---------- –õ–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è ----------
GUIDE_MEDIA: List[Union[None, str, List[str]]] = [
    "–°–Ω–∏–º–æ–∫ —ç–∫—Ä–∞–Ω–∞ 2025-08-26 –≤ 17.26.15.png",
    "–°–Ω–∏–º–æ–∫ —ç–∫—Ä–∞–Ω–∞ 2025-08-26 –≤ 17.26.24.png",
    "–°–Ω–∏–º–æ–∫ —ç–∫—Ä–∞–Ω–∞ 2025-08-26 –≤ 17.26.34.png",
    [
        "–°–Ω–∏–º–æ–∫ —ç–∫—Ä–∞–Ω–∞ 2025-08-26 –≤ 17.39.00.png",
        "–°–Ω–∏–º–æ–∫ —ç–∫—Ä–∞–Ω–∞ 2025-08-26 –≤ 17.37.56.png",
    ],
    [
        "–°–Ω–∏–º–æ–∫ —ç–∫—Ä–∞–Ω–∞ 2025-08-26 –≤ 17.40.06.png",
        "–°–Ω–∏–º–æ–∫ —ç–∫—Ä–∞–Ω–∞ 2025-08-26 –≤ 17.40.23.png",
        "–°–Ω–∏–º–æ–∫ —ç–∫—Ä–∞–Ω–∞ 2025-08-26 –≤ 17.40.40.png",
    ],
    "–°–Ω–∏–º–æ–∫ —ç–∫—Ä–∞–Ω–∞ 2025-08-26 –≤ 17.41.20.png",
]

# ---------- –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è ----------
REMIND_TEXT = "–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ‚ú®"
REMIND_JOB_PREFIX = "remind-everyday"

async def remind_everyday_job(context: ContextTypes.DEFAULT_TYPE):
    await context.bot.send_message(chat_id=context.job.chat_id, text=REMIND_TEXT)

def reminder_job_name(chat_id: int) -> str:
    return f"{REMIND_JOB_PREFIX}:{chat_id}"

def reminder_is_on(context: ContextTypes.DEFAULT_TYPE, chat_id: int) -> bool:
    return bool(context.job_queue.get_jobs_by_name(reminder_job_name(chat_id)))  # [11][6]

def reminder_enable(context: ContextTypes.DEFAULT_TYPE, chat_id: int, interval_hours: int = 24) -> None:
    name = reminder_job_name(chat_id)
    if context.job_queue.get_jobs_by_name(name):
        return
    context.job_queue.run_repeating(
        remind_everyday_job,
        interval=interval_hours * 60 * 60,
        first=0,
        chat_id=chat_id,
        name=name,
    )  # –∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–π –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–π—Å—è –¥–∂–æ–± –ª–µ–≥–∫–æ –æ—Ç–∫–ª—é—á–∞—Ç—å[11][12]

def reminder_disable(context: ContextTypes.DEFAULT_TYPE, chat_id: int) -> None:
    name = reminder_job_name(chat_id)
    for job in context.job_queue.get_jobs_by_name(name):
        job.schedule_removal()  # —à—Ç–∞—Ç–Ω–æ–µ –≤—ã–∫–ª—é—á–µ–Ω–∏–µ[11][6]

# ---------- –ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ----------
def get_saved_step(context: ContextTypes.DEFAULT_TYPE) -> int:
    return int(context.user_data.get("guide_step", 0))

def set_saved_step(context: ContextTypes.DEFAULT_TYPE, idx: int) -> None:
    context.user_data["guide_step"] = max(0, min(idx, LAST_STEP))

# ---------- –û—Ç–ø—Ä–∞–≤–∫–∞ —à–∞–≥–∞ ----------
async def send_guide_step(msg_target, idx: int):
    header = f"–®–∞–≥ {idx+1}/{LAST_STEP+1}"
    text = f"{header}\n\n{GUIDE_TEXTS[idx]}"
    kb = kb_guide(idx, LAST_STEP)
    media = GUIDE_MEDIA[idx]

    if isinstance(media, str):
        path = media_path(media)
        if not path.exists():
            log.error("Media file missing: %s", path)
        try:
            with open(path, "rb") as f:
                await msg_target.reply_photo(photo=f)  # file-like –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω –¥–ª—è PTB [2]
        except Exception as e:
            log.exception("send_guide_step file photo failed: %s | path=%s", e, path)

    elif isinstance(media, list) and media:
        files = []
        group = []
        try:
            for name in media:
                p = media_path(name)
                if not p.exists():
                    log.error("Media file missing in group: %s", p)
                f = open(p, "rb")
                files.append(f)
                group.append(InputMediaPhoto(f))  # –º–µ–¥–∏–∞–≥—Ä—É–ø–ø–∞ –∏–∑ –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ [2]
            await msg_target.reply_media_group(media=group)
        except Exception as e:
            log.exception("send_guide_step media_group failed: %s | names=%s", e, media)
        finally:
            for f in files:
                try:
                    f.close()
                except Exception:
                    pass

    await msg_target.reply_text(text, reply_markup=kb)

# ---------- –ú–µ–Ω—é –∏ –∫–æ–º–∞–Ω–¥—ã ----------
async def show_root_menu(context: ContextTypes.DEFAULT_TYPE, chat_id: int, target_message_id: Optional[int] = None) -> None:
    text = "–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"
    mark = kb_root()
    if target_message_id is not None:
        try:
            await context.bot.edit_message_text(chat_id=chat_id, message_id=target_message_id, text=text, reply_markup=mark)
            context.user_data["last_menu_id"] = target_message_id
            return
        except Exception:
            context.user_data["last_menu_id"] = None
    sent = await context.bot.send_message(chat_id=chat_id, text=text, reply_markup=mark)
    context.user_data["last_menu_id"] = sent.message_id  # —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ, –Ω–µ –∑–∞—Å–æ—Ä—è—è —á–∞—Ç [4]

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat = update.effective_chat
    user = update.effective_user
    name = ((user.first_name or "").strip()) or "–¥—Ä—É–≥"
    await context.bot.send_chat_action(chat_id=chat.id, action=ChatAction.TYPING)
    await context.bot.send_message(chat.id, f"–ü—Ä–∏–≤–µ—Ç, {name}! –≠—Ç–æ –±–æ—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.\n\n–í—ã–±–∏—Ä–∞–π —Ä–∞–∑–¥–µ–ª –Ω–∏–∂–µ.")
    await show_root_menu(context, chat.id)

async def help_cmd(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "–ö–æ–º–∞–Ω–¥—ã:\n"
        "/start ‚Äî –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é\n"
        "/help ‚Äî —Å–ø—Ä–∞–≤–∫–∞\n"
        "/reminder_on ‚Äî –≤–∫–ª—é—á–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ\n"
        "/reminder_off ‚Äî –≤—ã–∫–ª—é—á–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ"
    )

async def reminder_on_cmd(update: Update, context: ContextTypes.DEFAULT_TYPE):
    reminder_enable(context, update.effective_chat.id, interval_hours=24)
    await update.message.reply_text("üîî –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ. –°–æ–æ–±—â–µ–Ω–∏–µ —Ä–∞–∑ –≤ 24 —á–∞—Å–∞.")

async def reminder_off_cmd(update: Update, context: ContextTypes.DEFAULT_TYPE):
    reminder_disable(context, update.effective_chat.id)
    await update.message.reply_text("üîï –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –≤—ã–∫–ª—é—á–µ–Ω–æ.")

# ---------- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–æ–∫ ----------
async def on_button(update: Update, context: ContextTypes.DEFAULT_TYPE):
    q = update.callback_query
    await q.answer()
    data = q.data
    chat_msg = q.message
    chat_id = chat_msg.chat.id

    # –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –¥–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–æ–≥–æ –º–µ–Ω—é
    if data == CB_MAIN:
        await show_root_menu(context, chat_id, target_message_id=chat_msg.message_id)
        return

    if data == CB_MENU_TEST:
        await context.bot.edit_message_text(
            chat_id=chat_id,
            message_id=chat_msg.message_id,
            text="–ú–µ–Ω—é: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ",
            reply_markup=kb_test_menu(),
        )  # —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —á–∏—Å—Ç–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ [4]
        return

    if data == CB_MENU_ANN:
        await context.bot.edit_message_text(
            chat_id=chat_id,
            message_id=chat_msg.message_id,
            text="–ú–µ–Ω—é: –ê–Ω–æ–Ω—Å—ã –∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ",
            reply_markup=kb_ann_menu(),
        )  # –ø–æ–¥–º–µ–Ω—é –∞–Ω–æ–Ω—Å–æ–≤/–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π [4]
        return

    # –§—É–Ω–∫—Ü–∏–∏ —Ä–∞–∑–¥–µ–ª–∞ "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ"
    if data == CB_TEST:
        msg = (
            "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç –Ω–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–µ.\n\n"
            f"1) –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ —Å–∞–π—Ç: {TEST_LINK}\n"
            "2) –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è (–∏–ª–∏ –≤–æ–π—Ç–∏), —É–∫–∞–∑–∞—Ç—å e‚Äëmail.\n"
            "3) –û—Ç–∫—Ä—ã—Ç—å —Ä–∞–∑–¥–µ–ª ¬´–û—Ü–µ–Ω–∫–∞ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–π¬ª –∏ –Ω–∞–∂–∞—Ç—å ¬´–ü—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ¬ª."
        )
        await chat_msg.reply_text(msg, reply_markup=kb_test_menu())
        return

    if data == CB_GUIDE_OPEN:
        idx = get_saved_step(context)
        await send_guide_step(chat_msg, idx)
        return

    if data == CB_GUIDE_FAST:
        idx = 3
        set_saved_step(context, idx)
        await send_guide_step(chat_msg, idx)
        return

    if data.startswith(CB_GUIDE_NEXT) or data.startswith(CB_GUIDE_PREV):
        try:
            _, idx_str = data.split(":")
            idx = int(idx_str)
        except Exception:
            idx = get_saved_step(context)
        set_saved_step(context, idx)
        await send_guide_step(chat_msg, idx)
        return

    # –†–∞–∑–¥–µ–ª "–ê–Ω–æ–Ω—Å—ã –∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ"
    if data == CB_EVENTS:
        placeholder = "–ü–æ–∫–∞ –∑–¥–µ—Å—å –ø—É—Å—Ç–æ ‚Äî –∫–∞–∫ —Ç–æ–ª—å–∫–æ –ø–æ—è–≤—è—Ç—Å—è –±–ª–∏–∂–∞–π—à–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è, –±–æ—Ç –ø–µ—Ä–≤—ã–º —Å–æ–æ–±—â–∏—Ç ‚ú®"
        await chat_msg.reply_text(placeholder, reply_markup=kb_ann_menu())
        return

    if data == CB_REMINDER:
        if reminder_is_on(context, chat_id):
            reminder_disable(context, chat_id)
            await chat_msg.reply_text("üîï –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –≤—ã–∫–ª—é—á–µ–Ω–æ. –ú–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å —Å–Ω–æ–≤–∞ –≤ –º–µ–Ω—é —Ä–∞–∑–¥–µ–ª–∞.")
        else:
            reminder_enable(context, chat_id, interval_hours=24)
            await chat_msg.reply_text("üîî –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ. –ë–æ—Ç –±—É–¥–µ—Ç –ø–∏—Å–∞—Ç—å —Ä–∞–∑ –≤ 24 —á–∞—Å–∞.")
        return

# ---------- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è PTB ----------
async def post_init(application: Application) -> None:
    try:
        await application.bot.set_my_commands(
            [
                BotCommand("start", "–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞"),
                BotCommand("help", "–°–ø—Ä–∞–≤–∫–∞"),
                BotCommand("reminder_on", "–í–∫–ª—é—á–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ"),
                BotCommand("reminder_off", "–í—ã–∫–ª—é—á–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ"),
            ]
        )
    except Exception as e:
        log.warning("set_my_commands –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã: %s", e)

ptb = Application.builder().token(BOT_TOKEN).post_init(post_init).build()
ptb.add_handler(CommandHandler("start", start))
ptb.add_handler(CommandHandler("help", help_cmd))
ptb.add_handler(CommandHandler("reminder_on", reminder_on_cmd))
ptb.add_handler(CommandHandler("reminder_off", reminder_off_cmd))
ptb.add_handler(CallbackQueryHandler(on_button))

# ---------- FastAPI + webhook ----------
@asynccontextmanager
async def lifespan(_: FastAPI):
    if PUBLIC_BASE_URL:
        url = f"{PUBLIC_BASE_URL}/telegram-webhook"
        await ptb.bot.setWebhook(url)
        log.info("Webhook set to %s", url)
    else:
        log.error("PUBLIC_BASE_URL –ø—É—Å—Ç ‚Äî –≤–µ–±—Ö—É–∫ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.")
    async with ptb:
        await ptb.start()
        yield
        await ptb.stop()

app = FastAPI(lifespan=lifespan)

# –†–∞–∑–¥–∞—á–∞ —Å—Ç–∞—Ç–∏–∫–∏
app.mount("/static", StaticFiles(directory=str(STATIC_DIR)), name="static")  # [7]

# –í–µ–±—Ö—É–∫
@app.post("/telegram-webhook")
async def telegram_webhook(request: Request):
    payload = await request.json()
    update = Update.de_json(payload, ptb.bot)
    await ptb.process_update(update)
    return Response(status_code=HTTPStatus.OK)

# Health/Ready
@app.get("/health")
async def health():
    return {"status": "ok"}, status.HTTP_200_OK

@app.get("/ready")
async def ready():
    try:
        info = await ptb.bot.getWebhookInfo()
        return {
            "status": "ok",
            "webhook_url": info.url,
            "pending": info.pending_update_count,
        }, status.HTTP_200_OK
    except Exception as e:
        log.exception("Ready check failed: %s", e)
        return {"status": "error", "detail": str(e)}, status.HTTP_503_SERVICE_UNAVAILABLE

